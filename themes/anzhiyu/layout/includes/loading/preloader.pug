// preloader.pug
//- 样式
style.
  :root {
      --preloader-background-color: #fff;
      --preloader-text-color: #000;
  }

  @media (prefers-color-scheme: dark) {
      :root {
          --preloader-background-color: #202124;
          --preloader-text-color: #fff;
      }
  }

  @media (prefers-color-scheme: light) {
      :root {
          --preloader-background-color: #fff;
          --preloader-text-color: #000;
      }
  }

  @media (max-width: 600px) {
      .ml13 {
          font-size: 2.6rem !important;
      }
  }

  .preloader {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: var(--preloader-background-color);
      z-index: 1100;
      transition: opacity 0.2s ease-in-out;
  }

  .ml13 {
      font-size: 3.2rem;
      color: var(--preloader-text-color);
      letter-spacing: -1px;
      font-weight: 500;
      font-family: 'Chillax-Variable', sans-serif;
      text-align: center;
  }

  .ml13 .word {
      display: inline-flex;
      flex-wrap: wrap;
      white-space: nowrap;
  }

  .ml13 .letter {
      display: inline-block;
      line-height: 1em;
  }

//- HTML结构
.preloader
  h2.ml13 Loading...

//- JS 动画
//- 确保 anime.js 已经引入
script.
  window.addEventListener('load', function() {
      var textWrapper = document.querySelector('.ml13');
      var words = textWrapper.textContent.trim().split(' ');
      textWrapper.innerHTML = '';

      words.forEach(function(word) {
          var wordSpan = document.createElement('span');
          wordSpan.classList.add('word');
          wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
          textWrapper.appendChild(wordSpan);
          textWrapper.appendChild(document.createTextNode(' '));
      });

      // 动画
      var animation = anime.timeline({ loop: true })
          .add({
              targets: '.ml13 .letter',
              translateY: [20, 0],
              translateZ: 0,
              opacity: [0, 1],
              filter: ['blur(5px)', 'blur(0px)'],
              easing: "easeOutExpo",
              duration: 1200,
              delay: (el, i) => 300 + 20 * i,
          })
          .add({
              targets: '.ml13 .letter',
              translateY: [0, -20],
              opacity: [1, 0],
              filter: ['blur(0px)', 'blur(5px)'],
              easing: "easeInExpo",
              duration: 1000,
              delay: (el, i) => 15 * i,
              complete: function() {
                  hidePreloader();
              }
          }, '-=700');

      // 判断主题色
      let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;
      if (themeStatus === undefined || themeStatus === null) {
          themeStatus = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      if (themeStatus) {
          document.documentElement.style.setProperty('--preloader-background-color', '#202124');
          document.documentElement.style.setProperty('--preloader-text-color', '#fff');
      } else {
          document.documentElement.style.setProperty('--preloader-background-color', '#fff');
          document.documentElement.style.setProperty('--preloader-text-color', '#000');
      }

      // 自动隐藏
      setTimeout(hidePreloader, 5000);

      function hidePreloader() {
          var preloader = document.querySelector('.preloader');
          if (!preloader) return;
          preloader.style.opacity = '0';
          setTimeout(function() {
              preloader.style.display = 'none';
          }, 200);
      }
  });
